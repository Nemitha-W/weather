<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LankaSat Weather - Sri Lanka</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- Design System & Global Styles --- */
        :root {
            --bg-primary: #1E1E1E;
            --bg-secondary: #2A2A2A;
            --bg-panel: rgba(42, 42, 42, 0.95);
            --text-primary: #F0F0F0;
            --text-secondary: #B0B0B0;
            --accent-orange: #FF6B35;
            --accent-blue: #4A90E2;
            --alert-red: #D32F2F;
            --alert-orange: #F57C00;
            --alert-yellow: #FFC107;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html, #root {
            width: 100%;
            height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }
        
        /* Initial loading message */
        #initial-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        /* --- Component Styles --- */
        .app-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .leaflet-container {
            background-color: #0a0a0a;
        }

        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 15px 20px;
            background: linear-gradient(to bottom, rgba(30,30,30,0.95), transparent);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .header-bottom { display: flex; gap: 10px; align-items: center; }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .logo span { color: var(--accent-orange); }

        .search-container {
            position: relative;
            flex-grow: 1;
        }
        .search-input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--bg-secondary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }
        .search-input:focus { border-color: var(--accent-orange); }
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-panel);
            border: 1px solid var(--bg-secondary);
            border-radius: 8px;
            margin-top: 5px;
            max-height: 200px;
            overflow-y: auto;
            list-style: none;
            padding: 5px 0;
            z-index: 1001;
        }
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .suggestion-item:hover { background-color: var(--bg-secondary); }

        .use-location-btn {
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--accent-orange);
            background: transparent;
            color: var(--accent-orange);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.2s, color 0.2s;
        }
        .use-location-btn:hover {
            background-color: var(--accent-orange);
            color: var(--bg-primary);
        }

        .alert-banner {
            background-color: var(--alert-orange);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: center;
        }
        .alert-banner:hover { background-color: var(--alert-red); }

        .fab {
            position: absolute;
            bottom: 100px;
            right: 20px;
            z-index: 1000;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--accent-orange);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transition: transform 0.2s, background-color 0.2s;
        }
        .fab:hover { transform: scale(1.1); background-color: #ff8a5e; }

        .panel {
            position: absolute;
            left: 0;
            right: 0;
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--bg-secondary);
            z-index: 999;
            transition: transform 0.3s ease-in-out;
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .panel.hidden { transform: translateY(100%); }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .panel-title { font-size: 1.2rem; font-weight: 600; }
        .panel-close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .sat-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .sat-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--bg-secondary);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        .sat-btn.active {
            border-color: var(--accent-orange);
            color: var(--accent-orange);
            background: rgba(255, 107, 53, 0.1);
        }
        
        .weather-details { color: var(--text-primary); }
        .location-name { font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; }
        .weather-desc { font-size: 1rem; color: var(--text-secondary); text-transform: capitalize; margin-bottom: 20px; }
        
        .current-weather {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .current-temp { font-size: 4rem; font-weight: 300; line-height: 1; }
        .current-icon { font-size: 4rem; }
        .current-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 0.9rem;
        }
        .detail-item { display: flex; align-items: center; gap: 8px; }
        .detail-item span:first-child { color: var(--text-secondary); }

        .forecast-title { font-weight: 600; margin-top: 20px; margin-bottom: 10px; }
        .forecast-scroll {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        .forecast-card {
            min-width: 80px;
            text-align: center;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        .forecast-card .time { font-size: 0.8rem; color: var(--text-secondary); }
        .forecast-card .icon { font-size: 1.5rem; margin: 5px 0; }
        .forecast-card .temp { font-weight: 600; }
        .forecast-card .rain { font-size: 0.8rem; color: var(--accent-blue); }

        .loading, .error {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        @media (min-width: 768px) {
            .panel { border-radius: 20px 20px 0 0; }
            .fab { bottom: 120px; }
        }
    </style>
</head>
<body>

    <div id="root">
        <div id="initial-loader">Loading LankaSat Weather...</div>
    </div>

    <!-- React and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- React-Leaflet -->
    <script src="https://unpkg.com/react-leaflet@4.2.1/dist/react-leaflet.js"></script>

    <script type="text/babel">
        console.log("LankaSat App: Script started.");

        const { useState, useEffect, useCallback, useRef } = React;
        
        // --- DEBUGGING FIX: Safely access React-Leaflet components ---
        // This prevents the app from crashing if the library isn't loaded yet.
        const RLeaflet = window.ReactLeaflet;
        if (!RLeaflet) {
            console.error("LankaSat App: CRITICAL ERROR - window.ReactLeaflet is not defined. Check the CDN link for react-leaflet.js");
            // Display an error message to the user
            document.getElementById('root').innerHTML = '<div style="color:red; text-align:center; padding-top: 50px;">Failed to load application libraries. Please refresh or check your connection.</div>';
        }
        const { MapContainer, TileLayer, useMap } = RLeaflet || {};


        // --- Configuration ---
        const INITIAL_LOCATION = { lat: 6.9271, lon: 79.8612, name: "Colombo, Sri Lanka" };
        const OPEN_METEO_URL = "https://api.open-meteo.com/v1/forecast";
        const NOMINATIM_URL = "https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=";

        const SATELLITE_LAYERS = {
            infrared: { name: "Infrared", url: "https://picsum.photos/seed/ir-sat/256/256.jpg", attribution: 'Simulated IR Data' },
            visible: { name: "Visible", url: "https://picsum.photos/seed/vis-sat/256/256.jpg", attribution: 'Simulated VIS Data' },
            waterVapor: { name: "Water Vapor", url: "https://picsum.photos/seed/wv-sat/256/256.jpg", attribution: 'Simulated WV Data' },
        };

        // --- Helper Components ---

        function SatelliteOverlay({ layer }) {
            const map = useMap();
            const [overlay, setOverlay] = useState(null);

            useEffect(() => {
                if (overlay) map.removeLayer(overlay);
                if (layer) {
                    const newOverlay = L.tileLayer(layer.url, { attribution: layer.attribution });
                    newOverlay.addTo(map);
                    setOverlay(newOverlay);
                }
                return () => { if (overlay) map.removeLayer(overlay); };
            }, [layer, map]);
            return null;
        }
        
        function LocationSearch({ onLocationSelect }) {
            const [query, setQuery] = useState('');
            const [suggestions, setSuggestions] = useState([]);
            const timeoutId = useRef(null);

            useEffect(() => {
                if (query.length < 2) { setSuggestions([]); return; }
                clearTimeout(timeoutId.current);
                timeoutId.current = setTimeout(async () => {
                    try {
                        const response = await fetch(`${NOMINATIM_URL}${encodeURIComponent(query)}`);
                        const data = await response.json();
                        setSuggestions(data);
                    } catch (error) {
                        console.error("Geocoding failed:", error);
                        setSuggestions([]);
                    }
                }, 500);
                return () => clearTimeout(timeoutId.current);
            }, [query]);

            const handleSelect = (place) => {
                onLocationSelect({ lat: parseFloat(place.lat), lon: parseFloat(place.lon), name: place.display_name });
                setQuery(''); setSuggestions([]);
            };

            return (
                <div className="search-container">
                    <input className="search-input" placeholder="Search for a city..." value={query} onChange={(e) => setQuery(e.target.value)} />
                    <span className="search-icon">🔍</span>
                    {suggestions.length > 0 && (
                        <ul className="suggestions-list">
                            {suggestions.map((suggestion, index) => (
                                <li key={index} className="suggestion-item" onClick={() => handleSelect(suggestion)}>
                                    {suggestion.display_name}
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        }

        // --- Main App Component ---

        function App() {
            console.log("LankaSat App: App component mounted.");
            const [location, setLocation] = useState(INITIAL_LOCATION);
            const [weatherData, setWeatherData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isControlPanelOpen, setIsControlPanelOpen] = useState(false);
            const [isWeatherPanelOpen, setIsWeatherPanelOpen] = useState(true);
            const [activeSatLayer, setActiveSatLayer] = useState(null);
            const mapRef = useRef(null);

            const fetchWeather = useCallback(async (lat, lon) => {
                console.log(`LankaSat App: Fetching weather for ${lat}, ${lon}`);
                setLoading(true); setError(null);
                const params = new URLSearchParams({ latitude: lat, longitude: lon, current_weather: "true", hourly: "temperature_2m,relativehumidity_2m,windspeed_10m,weathercode", daily: "weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max", timezone: "auto", });
                try {
                    const response = await fetch(`${OPEN_METEO_URL}?${params}`);
                    if (!response.ok) throw new Error("Failed to fetch weather data");
                    const data = await response.json();
                    setWeatherData(data);
                    console.log("LankaSat App: Weather data fetched successfully.");
                } catch (err) {
                    console.error("LankaSat App: Error fetching weather:", err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            }, []);

            // Get user's current location on initial load
            useEffect(() => {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            console.log("LankaSat App: User location found.");
                            const newLoc = { lat: pos.coords.latitude, lon: pos.coords.longitude, name: "Your Location" };
                            setLocation(newLoc);
                            if (mapRef.current) {
                                mapRef.current.flyTo([newLoc.lat, newLoc.lon], 10, { duration: 2 });
                            }
                        },
                        (err) => console.error("LankaSat App: Geolocation error:", err)
                    );
                }
            }, []);

            // Fetch weather when location changes
            useEffect(() => {
                if (location) {
                    fetchWeather(location.lat, location.lon);
                }
            }, [location, fetchWeather]);

            const handleLocationSelect = (newLocation) => {
                console.log("LankaSat App: New location selected:", newLocation.name);
                setLocation(newLocation);
                if (mapRef.current) {
                    mapRef.current.flyTo([newLocation.lat, newLocation.lon], 10, { duration: 2 });
                }
            };
            
            const handleUseMyLocation = () => {
                 if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            const newLoc = { lat: pos.coords.latitude, lon: pos.coords.longitude, name: "Your Location" };
                            setLocation(newLoc);
                            if (mapRef.current) {
                                mapRef.current.flyTo([newLoc.lat, newLoc.lon], 10, { duration: 2 });
                            }
                        },
                        (err) => console.error("LankaSat App: Geolocation error:", err)
                    );
                }
            };

            return (
                <div className="app-container">
                    <header className="header">
                        <div className="header-top"><div className="logo">Lanka<span>Sat</span></div></div>
                        <div className="header-bottom">
                            <LocationSearch onLocationSelect={handleLocationSelect} />
                            <button className="use-location-btn" onClick={handleUseMyLocation}>📍 Use My Location</button>
                        </div>
                        <div className="alert-banner">⚠️ Heavy Rainfall Advisory: Southern Province</div>
                    </header>

                    <MapContainer
                        center={[location.lat, location.lon]}
                        zoom={8}
                        style={{ height: '100%', width: '100%' }}
                        ref={mapRef}
                    >
                        <TileLayer attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>' url="https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png" />
                        <SatelliteOverlay layer={activeSatLayer} />
                    </MapContainer>

                    <button className="fab" onClick={() => setIsControlPanelOpen(!isControlPanelOpen)}>🛰️</button>

                    <div className={`panel ${isControlPanelOpen ? '' : 'hidden'}`} style={{ bottom: isWeatherPanelOpen ? '320px' : '0px' }}>
                        <div className="panel-header">
                            <h3 className="panel-title">Satellite Layers</h3>
                            <button className="panel-close-btn" onClick={() => setIsControlPanelOpen(false)}>&times;</button>
                        </div>
                        <div className="sat-controls">
                            {Object.entries(SATELLITE_LAYERS).map(([key, layer]) => (
                                <button key={key} className={`sat-btn ${activeSatLayer?.name === layer.name ? 'active' : ''}`} onClick={() => setActiveSatLayer(activeSatLayer?.name === layer.name ? null : layer)}>{layer.name}</button>
                    ))}
                        </div>
                         <p style={{fontSize: '0.8rem', color: 'var(--text-secondary)'}}>Animation controls would be here.</p>
                    </div>

                    <div className={`panel ${isWeatherPanelOpen ? '' : 'hidden'}`} style={{ bottom: '0px' }}>
                        <div className="panel-header">
                            <h3 className="panel-title">Weather Details</h3>
                            <button className="panel-close-btn" onClick={() => setIsWeatherPanelOpen(false)}>&times;</button>
                        </div>
                        <div className="weather-details">
                            {loading && <div className="loading">Loading weather data...</div>}
                            {error && <div className="error">Error: {error}</div>}
                            {weatherData && location && (
                                <>
                                    <h2 className="location-name">{location.name}</h2>
                                    <p className="weather-desc">{getWeatherDescription(weatherData.current_weather.weathercode)}</p>
                                    <div className="current-weather">
                                        <div className="current-temp">{Math.round(weatherData.current_weather.temperature)}°C</div>
                                        <div className="current-icon">{getWeatherIcon(weatherData.current_weather.weathercode)}</div>
                                        <div className="current-details">
                                            <div className="detail-item"><span>💧</span> Humidity: {weatherData.hourly.relativehumidity_2m[0]}%</div>
                                            <div className="detail-item"><span>💨</span> Wind: {weatherData.current_weather.windspeed} km/h</div>
                                            <div className="detail-item"><span>🌡️</span> Feels like: {Math.round(weatherData.hourly.temperature_2m[0])}°C</div>
                                            <div className="detail-item"><span>🧭</span> Dir: {getWindDirection(weatherData.current_weather.winddirection)}</div>
                                        </div>
                                    </div>
                                    <h4 className="forecast-title">Hourly Forecast</h4>
                                    <div className="forecast-scroll">
                                        {weatherData.hourly.time.slice(0, 24).map((time, i) => (
                                            <div key={i} className="forecast-card">
                                                <div className="time">{new Date(time).getHours()}:00</div>
                                                <div className="icon">{getWeatherIcon(weatherData.hourly.weathercode[i])}</div>
                                                <div className="temp">{Math.round(weatherData.hourly.temperature_2m[i])}°</div>
                                                <div className="rain">{weatherData.hourly.relativehumidity_2m[i]}%</div>
                                            </div>
                                        ))}
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                    
                    {!isWeatherPanelOpen && (
                        <button className="fab" style={{bottom: '20px'}} onClick={() => setIsWeatherPanelOpen(true)}>☁️</button>
                    )}
                </div>
            );
        }

        // --- Utility Functions ---
        function getWeatherDescription(code) { const descriptions = { 0: "Clear", 1: "Mainly Clear", 2: "Partly Cloudy", 3: "Overcast", 45: "Fog", 48: "Fog", 51: "Drizzle", 53: "Drizzle", 55: "Drizzle", 56: "Freezing Drizzle", 57: "Freezing Drizzle", 61: "Rain", 63: "Rain", 65: "Heavy Rain", 66: "Freezing Rain", 67: "Freezing Rain", 71: "Snow", 73: "Snow", 75: "Heavy Snow", 80: "Rain Showers", 81: "Rain Showers", 82: "Violent Rain Showers", 95: "Thunderstorm", 96: "Thunderstorm", 99: "Severe Thunderstorm" }; return descriptions[code] || "Unknown"; }
        function getWeatherIcon(code) { const icons = { 0: "☀️", 1: "🌤️", 2: "⛅", 3: "☁️", 45: "🌫️", 48: "🌫️", 51: "🌦️", 53: "🌦️", 55: "🌦️", 61: "🌧️", 63: "🌧️", 65: "🌧️", 71: "🌨️", 73: "🌨️", 75: "❄️", 80: "🌦️", 81: "🌦️", 82: "⛈️", 95: "⛈️", 96: "⛈️", 99: "🌩️" }; return icons[code] || "🌡️"; }
        function getWindDirection(deg) { const directions = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"]; return directions[Math.round(deg / 22.5) % 16]; }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
  
